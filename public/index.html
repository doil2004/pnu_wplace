<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PNU Pixel Map Demo</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; }
    #map { width: 100vw; height: 100vh; }

    /* 로그인/회원가입 패널 */
    #auth-panel {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 1001;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 14px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   sans-serif;
      font-size: 13px;
      max-width: 260px;
    }

    #auth-panel h3 {
      margin-bottom: 4px;
      font-size: 14px;
    }

    #auth-panel form {
      margin-bottom: 8px;
    }

    #auth-panel input {
      width: 100%;
      margin-bottom: 4px;
      padding: 4px 6px;
      font-size: 12px;
    }

    #auth-panel button {
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    #color-picker {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 12px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      display: none;
      gap: 8px;
      align-items: center;
      z-index: 1000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   sans-serif;
    }

    .color-dot {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid #ddd;
      cursor: pointer;
    }

    #color-picker span {
      font-size: 14px;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <!-- 전체 화면 지도 -->
  <div id="map"></div>

  <!-- 로그인 / 회원가입 패널 -->
  <div id="auth-panel">
    <div id="logged-out">
      <h3>로그인</h3>
      <form id="login-form">
        <input type="email" name="email" placeholder="이메일" required />
        <input type="password" name="password" placeholder="비밀번호" required />
        <button type="submit">로그인</button>
      </form>

      <h3>회원가입</h3>
      <form id="register-form">
        <input type="email" name="email" placeholder="이메일" required />
        <input type="password" name="password" placeholder="비밀번호" required />
        <input type="text" name="nickname" placeholder="닉네임" required />
        <button type="submit">회원가입</button>
      </form>
    </div>

    <div id="logged-in" style="display:none;">
      <p><strong id="me-nickname"></strong>님 안녕하세요!</p>
      <button id="logout-btn">로그아웃</button>
      <p style="margin-top:6px; font-size:12px; color:#555;">
        · 지도를 클릭 → <br>
        &nbsp;&nbsp;셀 선택 후 아래에서 색 선택 <br>
        · 칠해진 칸 위에 마우스를 올리면<br>
        &nbsp;&nbsp;닉네임이 표시됩니다.
      </p>
    </div>
  </div>

  <!-- 색 선택 UI -->
  <div id="color-picker">
    <span>색 선택:</span>
    <!-- JS에서 컬러칩 생성 -->
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ==========================
    // 0. 로그인 상태 관리
    // ==========================
    let currentUser = null;

    async function fetchMe() {
      const res = await fetch('/api/auth/me');
      currentUser = await res.json();

      const loggedOut = document.getElementById('logged-out');
      const loggedIn = document.getElementById('logged-in');
      const nicknameSpan = document.getElementById('me-nickname');

      if (currentUser) {
        loggedOut.style.display = 'none';
        loggedIn.style.display = 'block';
        nicknameSpan.textContent = currentUser.nickname;
      } else {
        loggedOut.style.display = 'block';
        loggedIn.style.display = 'none';
      }
    }

    function initAuthForms() {
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const logoutBtn = document.getElementById('logout-btn');

      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(loginForm);
        const body = {
          email: formData.get('email'),
          password: formData.get('password'),
        };
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.message || '로그인 실패');
          return;
        }
        currentUser = data;
        await fetchMe();
      });

      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(registerForm);
        const body = {
          email: formData.get('email'),
          password: formData.get('password'),
          nickname: formData.get('nickname'),
        };
        const res = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.message || '회원가입 실패');
          return;
        }
        currentUser = data;
        await fetchMe();
      });

      logoutBtn.addEventListener('click', async () => {
        await fetch('/api/auth/logout', { method: 'POST' });
        currentUser = null;
        await fetchMe();
      });
    }

    // ==========================
    // 1. 지도 초기화 + 부산대 구획 제한
    // ==========================
    // 대략적인 부산대 본캠퍼스 구역 (필요하면 나중에 미세 조정)
    const pnuBounds = L.latLngBounds(
      [35.227, 129.077], // 남서
      [35.237, 129.092]  // 북동
    );

    const map = L.map('map', {
      center: [35.232, 129.084], // 캠퍼스 중간쯤
      zoom: 16,
      minZoom: 15,
      maxZoom: 19,
      maxBounds: pnuBounds,
      maxBoundsViscosity: 1.0 // 경계 바깥으로 잘 못 나가게 끈적하게
    });

    // 기본 OSM 대신 Carto의 연한 라이트맵 사용 (채도 덜 쨍함)
    L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png',
      {
        attribution:
          '&copy; OpenStreetMap, &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
      }
    ).addTo(map);

    // ==========================
    // 2. 그리드 설정 (10px)
    // ==========================
    const BASE_ZOOM = 18;     // 기준 줌
    const CELL_SIZE = 10;     // 10px x 10px (월드 픽셀 기준)

    // key: "x,y"  value: { x, y, color, nickname, rect }
    const cells = new Map();
    const cellLayerGroup = L.layerGroup().addTo(map);

    // 선택된 셀 하이라이트용 레이어
    const selectionLayer = L.layerGroup().addTo(map);
    let selectedRect = null;
    let pendingCell = null;  // { cellX, cellY }

    // ==========================
    // 3. 좌표 변환 함수
    // ==========================
    function latLngToCell(latlng) {
      // 위경도 -> 기준 줌에서의 픽셀 좌표
      const p = map.project(latlng, BASE_ZOOM);
      const cellX = Math.floor(p.x / CELL_SIZE);
      const cellY = Math.floor(p.y / CELL_SIZE);
      return { cellX, cellY };
    }

    function cellToBounds(cellX, cellY) {
      const nwPoint = L.point(cellX * CELL_SIZE, cellY * CELL_SIZE);
      const sePoint = L.point((cellX + 1) * CELL_SIZE, (cellY + 1) * CELL_SIZE);

      const nwLatLng = map.unproject(nwPoint, BASE_ZOOM);
      const seLatLng = map.unproject(sePoint, BASE_ZOOM);

      return [nwLatLng, seLatLng]; // Leaflet rectangle bounds
    }

    // ==========================
    // 4. 색 선택 UI 준비
    // ==========================
    const colors = ['#ff6b6b', '#ffdd59', '#1dd1a1', '#54a0ff', '#576574'];
    const colorPicker = document.getElementById('color-picker');

    colors.forEach(c => {
      const el = document.createElement('div');
      el.className = 'color-dot';
      el.style.backgroundColor = c;
      el.addEventListener('click', async () => {
        if (!pendingCell) return;
        const { cellX, cellY } = pendingCell;
        await paintCell(cellX, cellY, c);
        pendingCell = null;
        colorPicker.style.display = 'none';
        clearSelectionHighlight();
      });
      colorPicker.appendChild(el);
    });

    function clearSelectionHighlight() {
      if (selectedRect) {
        selectionLayer.removeLayer(selectedRect);
        selectedRect = null;
      }
    }

    // ==========================
    // 5. 셀 그리기 & 저장
    // ==========================
    function drawCell(cell) {
      const bounds = cellToBounds(cell.x, cell.y);
      const rect = L.rectangle(bounds, {
        color: cell.color,
        weight: 0,
        fillColor: cell.color,
        fillOpacity: 0.8,
      });

      // 호버 시 닉네임 툴팁
      if (cell.nickname) {
        rect.bindTooltip(cell.nickname, {
          direction: 'top',
          sticky: true
        });
      }

      rect.addTo(cellLayerGroup);
      cell.rect = rect;
    }

    async function paintCell(cellX, cellY, color) {
      if (!currentUser) {
        alert('로그인 후 픽셀을 칠할 수 있습니다.');
        return;
      }

      const key = `${cellX},${cellY}`;
      if (cells.has(key)) {
        alert('이미 누군가 칠한 칸입니다.');
        return;
      }

      // 백엔드에 저장
      const res = await fetch('/api/cells', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ x: cellX, y: cellY, color }),
      });
      const data = await res.json();
      if (!res.ok) {
        alert(data.message || '픽셀 저장 실패');
        return;
      }

      // 성공하면 클라이언트 상태 업데이트
      const cell = {
        x: cellX,
        y: cellY,
        color,
        nickname: currentUser.nickname,
      };
      cells.set(key, cell);
      drawCell(cell);
    }

    // ==========================
    // 6. DB에서 기존 셀 불러오기
    // ==========================
    async function loadCellsFromServer() {
      const res = await fetch('/api/cells');
      const list = await res.json();
      list.forEach(c => {
        const key = `${c.x},${c.y}`;
        const cell = {
          x: c.x,
          y: c.y,
          color: c.color,
          nickname: c.nickname,
        };
        cells.set(key, cell);
        drawCell(cell);
      });
    }

    // ==========================
    // 7. 지도 클릭 핸들러
    // ==========================
    map.on('click', (e) => {
      // 부산대 경계 밖 클릭이면 무시
      if (!pnuBounds.contains(e.latlng)) {
        return;
      }

      const { cellX, cellY } = latLngToCell(e.latlng);
      const key = `${cellX},${cellY}`;

      // 이미 칠해진 칸이면: 닉네임만 알림
      if (cells.has(key)) {
        const cell = cells.get(key);
        alert(`이미 "${cell.nickname}" 님이 칠한 칸입니다.`);
        clearSelectionHighlight();
        colorPicker.style.display = 'none';
        return;
      }

      // 빈 칸이면: 선택한 셀 하이라이트 + 색 선택 UI
      pendingCell = { cellX, cellY };

      // 기존 선택 사각형 제거
      clearSelectionHighlight();

      // 새 선택 사각형 생성
      const bounds = cellToBounds(cellX, cellY);
      selectedRect = L.rectangle(bounds, {
        color: '#ffffff',
        weight: 2,
        dashArray: '4,2',
        fill: false
      }).addTo(selectionLayer);

      colorPicker.style.display = 'flex';
    });

    // ==========================
    // 8. 초기화
    // ==========================
    document.addEventListener('DOMContentLoaded', async () => {
      initAuthForms();
      await fetchMe();
      await loadCellsFromServer();
    });
  </script>
</body>
</html>
