<!DOCTYPE html>
<html lang="ko">
  <head>
    <!-- 사용 라이브러리: Leaflet(지도 표시용), Socket.IO -->

    <title>PNU-WPLACE</title>
    <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    
    <link rel="stylesheet" href="./styles.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script src="./src/test.js"></script>
    <script src="./src/elements/pixel.js"></script>
    <script src="./src/elements/color-picker.js"></script>
    <script src="./src/elements/auth-card.js"></script>
  </head>
  <body>
    
    <div id="map"></div>
    
    <div id="color-picker">
      <span>색 선택:</span>
    </div>

    <div id="auth-card" class="card auth-card" 
      data-mode="login"
      data-logged-in=false
    >
      <div class="logged-out">
        <div class="auth-tabs">
          <button class="auth-tab active" data-mode="login">로그인</button>
          <button class="auth-tab" data-mode="register">회원가입</button>
        </div>

        <form class="login-form">
          <input id="login-email" class="auth-field" 
            type="email" name="email" required
            placeholder="이메일"
          />
          <input id="login-password" class="auth-field" 
            type="password" name="password" required
            placeholder="비밀번호"
          />
          <button type="submit" class="auth-submit">로그인</button>
        </form>

        <form class="register-form">
          <input id="register-email" class="auth-field" 
            type="email" name="email" required
            placeholder="이메일"
          />
          <input id="register-password" class="auth-field" 
            type="password" name="password" required
            placeholder="비밀번호"
          />
          <input id="register-nickname" class="auth-field" 
            type="nickname" name="nickname"
            placeholder="닉네임"
          />
          <button type="submit" class="auth-submit">회원가입</form>
        </form>
      </div>
      <div class="logged-in">
        <p class="logged-in-greeting">
          <strong class="me-nickname"></strong>님 안녕하세요!
        </p>

        <button class="logout-btn">로그아웃</button>

        <p class="auth-guide">
          · 아래에서 색 선택 → <br>
          &nbsp;&nbsp;칠하고 싶은 셀 클릭 <br>
          · 칠해진 칸 위에 마우스를 올리면&nbsp;<br>
          &nbsp;&nbsp;닉네임이 표시됩니다.
        </p>
      </div>
    </div>

    <script>
      // 부산대 영역
      const pnuBounds = L.latLngBounds(
        [35.229, 129.073], // 남서
        [35.239, 129.088]  // 북동
      );

      // 지도 생성
      const map = L.map('map', {
        center: [35.232, 129.084],
        zoom: 16,
        minZoom: 15,
        maxZoom: 19,
        maxBounds: pnuBounds,
        maxBoundsViscosity: 1.0
      });

      // 기본 타일 레이어
      L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png',
        {
          attribution: '&copy; OpenStreetMap, &copy; CARTO',
          subdomains: 'abcd',
          maxZoom: 20
        }
      ).addTo(map);
      
      const COLORS = [
        '#ff3b30', // 빨강
        '#ff9500', // 주황
        '#ffcc00', // 노랑
        '#34c759', // 초록
        '#007aff', // 파랑
        '#5856d6', // 남보라
        '#af52de', // 보라
      ];
      
      const colorPicker = new ColorPicker("color-picker", COLORS); // src/elements/color-picker.js
      const auth = new AuthCard("auth-card"); // src/elements/auth-card.js

      map.whenReady(async () => {
        console.log('[Debug] map ready, adding layers');
        
        const pixelLayer = new PixelGridLayer(); // src/elements/pixel.js
        pixelLayer.addTo(map).bringToFront();

        // 초기 지도의 픽셀 상태 요청
        const res = await fetch('/api/cells');
        const list = await res.json();
        list.forEach(cell => {
          const latlng = pixelLayer.cellToLatLngCenter(cell.x, cell.y);
          pixelLayer.paintPixelAt(latlng, cell.color, cell.nickname);
        });
        
        // 소켓 연결
        const socket = io();
        socket.on('connect', () => {
          console.log('✅ WebSocket connected:', socket.id);
        });
  
        // 서버의 실시간 픽셀 변경사항 반영
        socket.on('cell_update', cell => {
          const { x, y, color, nickname } = cell;
          const latlng = pixelLayer.cellToLatLngCenter(x, y);
          pixelLayer.paintPixelAt(
            latlng, 
            color,
            nickname
          );
        });

        // 지도 클릭 -> 픽셀 찍기
        map.on('click', async event => {
          if (!pnuBounds.contains(event.latlng)) {
            return;
          }
          if (!auth.user) {
            alert("로그인 후 픽셀을 칠할 수 있습니다.");
            return;
          }
          const { cellX, cellY } = pixelLayer.latLngToCell(event.latlng);
          const color = colorPicker.currentColor;

          if (pixelLayer.getCell(cellX, cellY)) {
            alert(`이미 "${cell.nickname}" 님이 칠한 칸입니다.`);
            return;
          }

          // 픽셀을 찍는 건 HTTP POST로 구현
          const res = await fetch('/api/cells', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ x: cellX, y: cellY, color }),
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data.message || '픽셀 저장 실패');
            return;
          }

          pixelLayer.paintPixelAt(
            event.latlng,
            color,
            auth.user.nickname
          );
        });
      });
      
      // 테스트용 함수
      function showDebugLayer() {
        const debugLayer = new DebugGridLayer(); // src/test.js
        debugLayer.addTo(map).bringToFront();
      }

    </script>
  </body>
</html>